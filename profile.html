<!DOCTYPE html>
<html lang="en">
  <head>
    <title>ForkIt – Profile</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <!-- Bootstrap & Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <!-- Palette + bottoni -->
    <link rel="stylesheet" href="/css/palette.css" />
    <link rel="stylesheet" href="/css/button.css" />
    <link rel="stylesheet" href="/css/scroll.css" />
    <link rel="stylesheet" href="/css/detail.css" />

    <script src="/utils.js"></script>
  </head>

  <body>
    <header><div id="navbar-placeholder"></div></header>

    <main>
      <div class="container-fluid ms-4 py-5">
        <h2 class="mb-4">
          Profilo Utente
          <button
            class="bg-transparent mb-1 ms-2 border-0 fs-5 icon-btn"
            onclick="attivaModifica()"
          >
            <i class="bi bi-pencil"></i>
          </button>
        </h2>

        <div class="row">
          <!-- Info utente -->
          <div class="col">
            <ul class="list-group mb-2" id="user-info">
              <li class="list-group-item border-0 bg-transparent">
                <strong>Nome:</strong> <span id="first-name"></span>
              </li>
              <li class="list-group-item border-0 bg-transparent">
                <strong>Cognome:</strong> <span id="last-name"></span>
              </li>
              <li class="list-group-item border-0 bg-transparent">
                <strong>Email:</strong> <span id="email"></span>
              </li>
              <li class="list-group-item border-0 bg-transparent">
                <strong id="rist-title">Ristorante preferito:</strong>
                <span id="fav-restaurant"></span>
              </li>
              <li class="list-group-item border-0 bg-transparent">
                <strong>Carta di pagamento:</strong>
                <span id="payment-method"></span>
              </li>
              <li class="list-group-item border-0 bg-transparent">
                <strong>Tipo di profilo:</strong>
                <span id="role-type"></span>
              </li>
              <li class="list-group-item border-0 bg-transparent">
                <strong>Password:</strong>
                <span>********</span>
                <button
                  class="bg-transparent ms-2 border-0 fs-5 icon-btn"
                  onclick="cambioPassword()"
                >
                  <i class="bi bi-pencil small"></i>
                </button>
              </li>
            </ul>
          </div>

          <!--  DATI RISTORANTE  -->
          <div id="restaurant-info" class="row d-none">
            <div class="col">
              <h4 class="text-teal mb-3">
                Dati Ristorante
                <button
                  class="bg-transparent mb-1 ms-2 border-0 fs-5 icon-btn"
                  onclick="attivaModificaRistorante()"
                >
                  <i class="bi bi-pencil"></i>
                </button>
              </h4>

              <ul class="list-group mb-4" id="rist-info">
                <li class="list-group-item border-0 bg-transparent">
                  <strong>Nome:</strong> <span id="rist-name"></span>
                </li>
                <li class="list-group-item border-0 bg-transparent">
                  <strong>Indirizzo:</strong> <span id="rist-address"></span>
                </li>
                <li class="list-group-item border-0 bg-transparent">
                  <strong>Contatti:</strong> <span id="rist-contacts"></span>
                </li>
                <li class="list-group-item border-0 bg-transparent">
                  <strong>Orari di apertura:</strong>
                  <span id="rist-hours"></span>
                </li>
                <li class="list-group-item border-0 bg-transparent">
                  <strong>P. IVA:</strong> <span id="rist-piva"></span>
                </li>
              </ul>
            </div>
          </div>

          <!--  FORM MODIFICA RISTORANTE  -->
          <div id="rist-edit-form" class="d-none p-5 z-1 detail">
            <h4 class="text-teal">Modifica Dati Ristorante</h4>
            <form onsubmit="submitModificaRistorante(event)">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Nome</label>
                  <input id="edit-rist-name" class="form-control" required />
                </div>

                <!-- Contatti -->
                <div class="col-md-6">
                  <label class="form-label">Cellulare Ristorante</label>
                  <input id="edit-rist-tel2" class="form-control" />
                </div>

                <div class="col-md-2">
                  <label class="form-label">Lun–Ven apertura 1</label>
                  <input id="edit-open1" class="form-control" required />
                </div>
                <div class="col-md-2">
                  <label class="form-label">Lun–Ven chiusura 1</label>
                  <input id="edit-close1" class="form-control" required />
                </div>
                <div class="col-md-2">
                  <label class="form-label">Lun–Ven apertura 2</label>
                  <input id="edit-open2" class="form-control" />
                </div>
                <div class="col-md-2">
                  <label class="form-label">Lun–Ven chiusura 2</label>
                  <input id="edit-close2" class="form-control" />
                </div>

                <div class="col-md-2">
                  <label class="form-label">Sab–Dom apertura</label>
                  <input id="edit-openWE" class="form-control" required />
                </div>
                <div class="col-md-2">
                  <label class="form-label">Sab–Dom chiusura</label>
                  <input id="edit-closeWE" class="form-control" required />
                </div>

                <!-- P.IVA -->
                <div class="col-md-6">
                  <label class="form-label">Partita IVA</label>
                  <input id="edit-piva" class="form-control" required />
                </div>

                <!-- Password di conferma -->
                <div class="col-md-6">
                  <label class="form-label">Password (per confermare)</label>
                  <input
                    id="edit-password-datiRist"
                    type="password"
                    class="form-control"
                    required
                  />
                </div>

                <!-- Pulsanti -->
                <div class="col-12 mt-3">
                  <button type="submit" class="btn-teal-deep">
                    Salva Modifiche
                  </button>
                  <button
                    type="button"
                    class="btn-delete ms-2"
                    onclick="annullaModificaRistorante()"
                  >
                    Annulla
                  </button>
                </div>
              </div>
            </form>
          </div>

          <div class="row">
            <!-- Cibi preferiti -->
            <div class="col scroll-container">
              <h4 class="text-teal">Cibi preferiti</h4>
              <div
                id="fav-meals"
                class="scroll-container d-flex overflow-auto gap-3 pb-2"
              ></div>
            </div>
          </div>
        </div>

        <button
          id="delete-btn"
          class="btn-delete mt-2"
          onclick="deleteProfile()"
        >
          Delete Profile
        </button>
        <button class="btn-warm-wood mt-2" onclick="logout()">Logout</button>
      </div>

      <!-- Dettaglio cibo -->
      <div id="meal-detail" class="detail d-none">
        <div class="container py-4">
          <button
            id="close-detail"
            class="btn-teal-deep mb-3"
            onclick="closeDetail()"
          >
            <i class="bi bi-x-lg"></i> Chiudi
          </button>
          <div id="meal-detail-content" class="bg-white p-4 rounded"></div>
        </div>
      </div>

      <!--FORM PER MODIFICA PASSWORD-->
      <div id="password-form" class="detail d-none p-5">
        <h4 class="text-teal">Cambia Password</h4>
        <form onsubmit="submitCambioPassword(event)">
          <div class="row g-3">
            <!-- Password attuale -->
            <div class="col-md-4">
              <label class="form-label">Password attuale</label>
              <input
                id="old-password"
                type="password"
                class="form-control"
                required
              />
            </div>

            <!-- Nuova password -->
            <div class="col-md-4">
              <label class="form-label">Nuova password</label>
              <input
                id="new-password"
                type="password"
                class="form-control"
                required
              />
            </div>

            <!-- Conferma nuova password -->
            <div class="col-md-4">
              <label class="form-label">Conferma nuova password</label>
              <input
                id="confirm-password"
                type="password"
                class="form-control"
                required
              />
            </div>

            <!-- Pulsanti -->
            <div class="col-12 mt-3">
              <button type="submit" class="btn-teal-deep">
                Aggiorna Password
              </button>
              <button
                type="button"
                class="btn-delete ms-2"
                onclick="annullaCambioPassword()"
              >
                Annulla
              </button>
            </div>
          </div>
        </form>
      </div>

      <!-- FORM PER MODIFICA DATI CLIENT-->
      <div id="edit-form" class="detail d-none p-5">
        <h4 class="text-teal">Modifica Profilo</h4>
        <form onsubmit="submitModifica(event)">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Nome</label>
              <input id="edit-name" class="form-control" required />
            </div>
            <div class="col-md-4">
              <label class="form-label">Cognome</label>
              <input id="edit-surname" class="form-control" required />
            </div>
            <div class="col-md-4">
              <label class="form-label">Email</label>
              <input
                id="edit-email"
                type="email"
                class="form-control"
                required
              />
            </div>

            <div id="payment-section" class="row g-3">
              <div class="col-md-4 col-12">
                <label class="form-label">Numero Carta</label>
                <input id="edit-card-number" class="form-control" />
              </div>
              <div class="col-md-2">
                <label class="form-label"
                  >Scadenza <span class="text-muted small">(MM/YY)</span></label
                >
                <input id="edit-expiry" class="form-control" />
              </div>
              <div class="col-md-2">
                <label class="form-label">CVV</label>
                <input id="edit-cvv" class="form-control" />
              </div>
              <div class="col-md-4">
                <label class="form-label">Intestatario</label>
                <input id="edit-card-owner" class="form-control" />
              </div>
            </div>

            <!-- Ristorante preferito -->
            <div class="col-md-4" id="edit-restaurant-div">
              <label class="form-label">Ristorante Preferito</label>
              <select id="edit-restaurant" class="form-select">
                <option value="">Nessun ristorante preferito</option>
              </select>
            </div>

            <!-- Password di conferma -->
            <div class="col-md-8">
              <label class="form-label">Password (per confermare)</label>
              <input
                id="edit-password"
                type="password"
                class="form-control"
                required
              />
            </div>

            <!-- Pulsanti -->
            <div class="col-12 mt-3">
              <button type="submit" class="btn-teal-deep">
                Salva Modifiche
              </button>
              <button
                type="button"
                class="btn-delete ms-2"
                onclick="annullaModifica()"
              >
                Annulla
              </button>
            </div>
          </div>
        </form>
      </div>
    </main>

    <footer><div id="footer-placeholder"></div></footer>

    <script>
      let user;
      let rist;
      document.addEventListener("DOMContentLoaded", async () => {
        await loadNavbar();
        setupNavbar();
        loadFooter();
        user = await loadUserData();
        if (user.restaurant) rist = await loadRestaurantData(user.restaurant);
        showUserData();
        showRestaurantData();
      });

      //Mostra i dati del ristorante
      async function showRestaurantData() {
        if (user.role !== "restorator") return;

        document.getElementById("restaurant-info").classList.remove("d-none");

        // Popola campi
        document.getElementById(
          "rist-name"
        ).textContent = `ForkIt ${rist.name}`;
        document.getElementById(
          "rist-address"
        ).textContent = `${rist.address.street}, ${rist.address.city} (${rist.address.province}) ${rist.address.postalCode}`;
        document.getElementById("rist-contacts").textContent = `${
          rist.contacts.tel
        } | ${rist.contacts.tel2 || "–"} | ${rist.contacts.email}`;
        document.getElementById("rist-hours").textContent = formatHours(
          rist.openingHours
        );
        document.getElementById("rist-piva").textContent = rist.PIVA;
      }

      //Attiva modifica dati ristorante
      async function attivaModificaRistorante() {
        if (user.role !== "restorator") return;

        // riempi campi
        document.getElementById("edit-rist-name").value = rist.name;
        document.getElementById("edit-rist-tel2").value =
          rist.contacts.tel2 || "";

        const [slot1, slot2] = rist.openingHours.lunVen;
        document.getElementById("edit-open1").value = slot1.open;
        document.getElementById("edit-close1").value = slot1.close;
        document.getElementById("edit-open2").value = slot2?.open || "";
        document.getElementById("edit-close2").value = slot2?.close || "";

        document.getElementById("edit-openWE").value =
          rist.openingHours.sabDom.open;
        document.getElementById("edit-closeWE").value =
          rist.openingHours.sabDom.close;

        document.getElementById("edit-piva").value = rist.PIVA;

        document.getElementById("rist-edit-form").classList.remove("d-none");
      }

      //Annulla modifiche ristorante
      function annullaModificaRistorante() {
        document.getElementById("rist-edit-form").classList.add("d-none");
      }

      //Submit modifiche ristorante
      async function submitModificaRistorante(e) {
        e.preventDefault();
        if (user.role !== "restorator") return;
        const password = document.getElementById(
          "edit-password-datiRist"
        ).value;
        if (user.password !== password) {
          showTemporaryAlert("Password per conferma errata", "danger");
          return;
        }

        const body = {
          name: document.getElementById("edit-rist-name").value.trim(),
          contacts: {
            tel2: document.getElementById("edit-rist-tel2").value.trim(),
          },
          openingHours: {
            lunVen: [
              {
                open: document.getElementById("edit-open1").value,
                close: document.getElementById("edit-close1").value,
              },
              {
                open: document.getElementById("edit-open2").value,
                close: document.getElementById("edit-close2").value,
              },
            ].filter((s) => s.open && s.close),
            sabDom: {
              open: document.getElementById("edit-openWE").value,
              close: document.getElementById("edit-closeWE").value,
            },
          },
          PIVA: document.getElementById("edit-piva").value.trim(),
        };

        const res = await fetch(
          `http://localhost:3001/restaurants/${rist._id}?password:${password}`,
          {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          }
        );

        if (res.ok) {
          showTemporaryAlert("Dati ristorante aggiornati", "success");
          document.getElementById("rist-edit-form").classList.add("d-none");
          document.getElementById("edit-password-datiRist").value = "";
          setTimeout(() => {
            window.location.reload();
          }, 1500);
        } else {
          const err = await res.json();
          showTemporaryAlert("Errore: " + err.message, "danger");
        }
      }

      //Mostra forma cambio password
      function cambioPassword() {
        document.getElementById("password-form").classList.remove("d-none");
      }

      //Annulla/chiude cambio password
      function annullaCambioPassword() {
        document.getElementById("password-form").classList.add("d-none");
        document.getElementById("old-password").value = "";
        document.getElementById("new-password").value = "";
        document.getElementById("confirm-password").value = "";
      }

      /* Submit cambio password */
      async function submitCambioPassword(e) {
        e.preventDefault();

        const oldPwd = document.getElementById("old-password").value;
        const newPwd = document.getElementById("new-password").value;
        const confPwd = document.getElementById("confirm-password").value;

        if (newPwd !== confPwd) {
          showTemporaryAlert("Le password non coincidono", "danger");
          return;
        }

        try {
          const res = await fetch(
            `http://localhost:3001/users/${user._id}/password`,
            {
              method: "PATCH",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                oldPassword: oldPwd,
                newPassword: newPwd,
              }),
            }
          );

          if (!res.ok) {
            const { message } = await res.json();
            showTemporaryAlert("Errore: " + message, "danger");
            return;
          }

          showTemporaryAlert("Password aggiornata con successo", "success");
          annullaCambioPassword();
        } catch (err) {
          showTemporaryAlert("Errore di rete: " + err.message, "danger");
        }
      }

      //Modifiche ai dati utente
      async function submitModifica(e) {
        e.preventDefault();
        const cvv = document.getElementById("edit-cvv").value !== "" ? document.getElementById("edit-cvv").value : user.paymentMethod.cvv;
        const body = {
          name: document.getElementById("edit-name").value,
          surname: document.getElementById("edit-surname").value,
          email: document.getElementById("edit-email").value,
          password: document.getElementById("edit-password").value,
          restaurant: document.getElementById("edit-restaurant").value,
          paymentMethod: {
            cardNumber: document.getElementById("edit-card-number").value,
            expiry: document.getElementById("edit-expiry").value,
            owner: document.getElementById("edit-card-owner").value,
            cvv: cvv,
          },
        };
        if (localStorage.getItem("role") !== "client")
          delete body.paymentMethod;
        if (localStorage.getItem("role") === "admin") delete body.restaurant;

        const res = await fetch(`http://localhost:3001/users/${user._id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        if (res.ok) {
          showTemporaryAlert("Profilo aggiornato con successo", "success");
          document.getElementById("edit-form").classList.add("d-none");
          (document.getElementById("edit-password").value = ""),
            setTimeout(() => {
              window.location.reload();
            }, 1500);
        } else {
          const err = await res.json();
          showTemporaryAlert("Errore: " + err.message, "danger");
        }
      }

      //Annlla inserimento dati nuovi
      function annullaModifica() {
        document.getElementById("edit-form").classList.add("d-none");
        document.getElementById("edit-password").value = "";
      }

      //Funzione per controllare se ha ordini attivi. Usato per avere eliminazione senza ordini orfani
      async function hasActiveOrders(user) {
        try {
          if (user.role === "client") {
            const res = await fetch(
              `http://localhost:3001/users/${user._id}/orders`
            );
            if (!res.ok) return true;
            const orders = await res.json();
            return orders.some((order) => order.state !== "consegnato");
          }
          if (user.role === "restorator") {
            const res = await fetch(
              `http://localhost:3001/restaurants/${user.restaurant}/orders`
            );
            if (!res.ok) return true;
            const orders = await res.json();
            return orders.some((order) => order.state !== "consegnato");
          }
        } catch {
          return true; //Se ho errori mando true e blocco cancellazione
        }
        return false;
      }

      //Mostra form per cambio dati
      async function attivaModifica() {
        const paymentSection = document.getElementById("payment-section");
        const ristSelect = document.getElementById("edit-restaurant");

        document.getElementById("edit-name").value = user.name;
        document.getElementById("edit-surname").value = user.surname;
        document.getElementById("edit-email").value = user.email;

        const restaurants = await fetch(
          "http://localhost:3001/restaurants"
        ).then((r) => r.json());
        restaurants.forEach((r) => {
          const option = document.createElement("option");
          option.value = r._id;
          option.textContent = `${r.name} - ${r.address.street}, ${r.address.city}`;
          if (r._id === user.restaurant) option.selected = true;
          ristSelect.appendChild(option);
        });

        if (user.role === "client") {
          // Mostra tutto con dati attuali
          paymentSection.classList.remove("d-none");
          ristSelect.disabled = false;
          ristSelect.classList.remove("d-none");
          if (user.paymentMethod) {
            document.getElementById("edit-card-number").value =
              user.paymentMethod.cardNumber;
            document.getElementById("edit-expiry").value =
              user.paymentMethod.expiry;
            document.getElementById("edit-card-owner").value =
              user.paymentMethod.owner;
            document.getElementById("edit-cvv").value = "";
          }
        } else if (user.role === "restorator") {
          // Nascondi payment, disabilita selezione ristorante ma visibile
          paymentSection.classList.add("d-none");
          ristSelect.disabled = true;
          ristSelect.classList.remove("d-none");
        } else if (user.role === "admin") {
          // Nascondi payment, disabilita e nascondi selezione ristorante
          document
            .getElementById("edit-restaurant-div")
            .classList.add("d-none");
          paymentSection.classList.add("d-none");
          ristSelect.disabled = true;
          ristSelect.classList.add("d-none");
        }

        document.getElementById("edit-form").classList.remove("d-none");
      }

      //Chiusura dettaglio
      function closeDetail() {
        document.getElementById("meal-detail").classList.add("d-none");
      }

      //Mostra dati utente
      async function showUserData() {
        const restaurantLabel =
          user.role === "restorator"
            ? "Ristorante in gestione:"
            : "Ristorante preferito:";
        const paymentInfo = document
          .getElementById("payment-method")
          .closest("li");
        const mealsTitle = document.querySelector(".scroll-container h4");
        const mealsContainer = document.getElementById("fav-meals");

        document.getElementById("first-name").textContent = user.name;
        document.getElementById("last-name").textContent = user.surname;
        document.getElementById("email").textContent = user.email;
        document.getElementById("role-type").textContent =
          user.role.charAt(0).toUpperCase() + user.role.slice(1);

        if (user.role === "admin") {
          document.getElementById("delete-btn").remove();
          // Nascondo ristorante e payment info
          document.getElementById("rist-title").classList.add("d-none");
          document.getElementById("fav-restaurant").classList.add("d-none");
          paymentInfo.classList.add("d-none");
          mealsTitle.classList.add("d-none");
          mealsContainer.classList.add("d-none");
        } else {
          document.getElementById("rist-title").textContent = restaurantLabel;
          console.log(rist);
          document.getElementById("fav-restaurant").innerHTML = rist
            ? `<a href="/restaurants.html?restaurantId=${rist._id}" class="text-warm-wood"> ForkIt ${rist.name} - ${rist.address.street}, ${rist.address.city} </a>`
            : user.role === "restorator"
            ? "Nessun ristorante assegnato"
            : "Nessun ristorante preferito";

          // Mostro pagamento solo se non restorator
          if (user.role === "restorator") {
            paymentInfo.classList.add("d-none");
          } else {
            paymentInfo.classList.remove("d-none");
            document.getElementById("payment-method").textContent =
              !user.paymentMethod
                ? "Nessuna carta inserita"
                : !user.paymentMethod.cardNumber
                ? "Nessuna carta inserita"
                : "**** **** **** " + user.paymentMethod.cardNumber.slice(-4);
          }
          mealsTitle.classList.remove("d-none");
          mealsTitle.textContent =
            user.role === "restorator"
              ? "Menu ristorante gestito"
              : "Cibi preferiti";
          mealsContainer.classList.remove("d-none");
          mealsContainer.innerHTML = "";

          //Mostra cibi preferiti/menu
          if (user.foods.length > 0) {
            const meals = await Promise.all(
              user.foods.map((id) =>
                fetch(`http://localhost:3001/meals/${id}`).then((meal) =>
                  meal.json()
                )
              )
            );
            //Filtro per i cibi che sono segnati eliminati
            meals
              .filter((m) => !m.deleted)
              .sort((a, b) => a.strMeal.localeCompare(b.strMeal))
              .forEach((meal) => {
                const card = document.createElement("div");
                card.className = "col-lg-2 col-md-3 col-6";
                card.innerHTML = `
       <div class="card h-100 cursor-pointer">
               <button class="position-absolute end-0 bottom-0 mb-1 ms-2 border-0 fs-5 bg-transparent icon-btn filled">
                <i class="bi bi-heart-fill"></i>
              </button>

                  <div class="ratio ratio-1x1">
          <img src="${meal.strMealThumb}" class="img-fluid object-fit-cover">
        </div>
                  <div class="card-body d-flex flex-column justify-content-between">
                    <div>
                      <h5 class="text-teal">${meal.strMeal}</h5>
                      <p class="text-muted">${meal.strTags || ""}</p>
                    </div>

                  </div>
                </div>`;

                card.querySelector(".card").addEventListener("click", (e) => {
                  if (e.target.closest(".icon-btn")) return;
                  showMealDetail(meal);
                });

                card
                  .querySelector(".icon-btn")
                  .addEventListener("click", async (e) => {
                    e.stopPropagation();
                    await deletePref(meal._id);
                    card.remove();
                  });

                mealsContainer.appendChild(card);
              });
          } else {
            mealsContainer.innerHTML =
              user.role === "restorator"
                ? "<p>Menu non disponibile.</p>"
                : "<p>Nessun cibo preferito.</p>";
          }
        }
      }

      //Permette di eliminare preferiti anche da profilo e non solo da menu
      async function deletePref(mealId) {
        const url = `http://localhost:3001/users/${user._id}/favorites`;
        const options = {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ mealId }),
        };

        try {
          const res = await fetch(url, options);
          if (res.ok) {
            localStorage.getItem("role") == "restorator"
              ? showTemporaryAlert("Piatto rimosso da menu", "success")
              : showTemporaryAlert("Piatto rimosso da preferiti", "success");

            window.location.reload();
          } else {
            console.error("Errore nella rimozione preferito");
            showTemporaryAlert("Errore nella rimozione preferito", "danger");
          }
        } catch (err) {
          console.error("Errore nella richiesta dei preferiti:", err);
          showTemporaryAlert("Errore nella richiesta", "danger");
        }
      }

      //Effettua il logout
      function logout() {
        localStorage.removeItem("role");
        localStorage.removeItem("user_id");
        localStorage.removeItem("cart");
        window.location.href = "http://localhost:3001/index.html";
      }

      //Elimina il profilo in modo definitivo
      async function deleteProfile() {
        if (await hasActiveOrders(user)) {
          showTemporaryAlert(
            "Non puoi eliminare il profilo: ci sono ordini ancora in corso.",
            "danger"
          );
          return;
        }

        const ok = confirm(
          "Vuoi davvero eliminare il tuo profilo? L’operazione è irreversibile."
        );
        if (!ok) return;

        try {
          const res = await fetch(`http://localhost:3001/users/${user._id}`, {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
            },
          });
          if (!res.ok) {
            const error = res.json();
            showTemporaryAlert(
              `Errore nella cancellazione:${error.message}`,
              "danger"
            );
            return;
          }

          localStorage.clear();
          showTemporaryAlert("Profilo eliminato con successo!", "success");
          setTimeout(() => {
            window.location.href = "http://localhost:3001/index.html";
          }, 1500);
        } catch (err) {
          alert("Errore connessione database: " + err.message);
        }
      }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
